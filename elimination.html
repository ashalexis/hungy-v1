<!DOCTYPE html>
<html>

<head>
    <title>Let's choose!</title>
    <meta lang="en" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/elimination.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;700&display=swap" rel="stylesheet" />
</head>

<body>
    <span class="loader" id="loader" style="display: none"></span>
    <section id="roomInput">
        <button id="newRoom" type="button">Create new room</button>
        <span>OR...</span>
        <label for="roomId">Room #:</label>
        <input type="text" id="roomId" name="roomId" />
        <button id="joinRoom" type="button">Join room</button>
    </section>

    <section id="selection">
        <h1>What would you like to eat?</h1>
        <p>Remove one each until one more remains</p>
        <form id="form">
            <fieldset>
                <div class="foodbutton">
                    <label for="chinese">
							<input
								type="radio"
								id="chinese"
								name="foodChoice"
								value="Chinese"
							/>
							<span>Chinese</span>
						</label>
                </div>
                <div class="foodbutton">
                    <label for="indian">
							<input
								type="radio"
								id="indian"
								name="foodChoice"
								value="Indian"
							/>
							<span>Indian</span>
						</label>
                </div>
                <div class="foodbutton">
                    <label for="japanese">
							<input
								type="radio"
								id="japanese"
								name="foodChoice"
								value="Japanese"
							/>
							<span>Japanese</span>
						</label>
                </div>
                <div class="foodbutton">
                    <label for="korean">
							<input
								type="radio"
								id="korean"
								name="foodChoice"
								value="Korean"
							/>
							<span>Korean</span>
						</label>
                </div>
                <div class="foodbutton">
                    <label for="malaysian">
							<input
								type="radio"
								id="malaysian"
								name="foodChoice"
								value="Malaysian"
							/>
							<span>Malaysian</span>
						</label>
                </div>
                <div class="foodbutton">
                    <label for="thai">
							<input type="radio" id="thai" name="foodChoice" value="Thai" />
							<span>Thai</span>
						</label>
                </div>
                <div class="foodbutton">
                    <label for="lebanese">
							<input
								type="radio"
								id="lebanese"
								name="foodChoice"
								value="Lebanese"
							/>
							<span>Lebanese</span>
						</label>
                </div>
                <div class="foodbutton">
                    <label for="italian">
							<input
								type="radio"
								id="italian"
								name="foodChoice"
								value="Italian"
							/>
							<span>Italian</span>
						</label>
                </div>
                <div class="foodbutton">
                    <label for="french">
							<input
								type="radio"
								id="french"
								name="foodChoice"
								value="French"
							/>
							<span>French</span>
						</label>
                </div>
                <div class="foodbutton">
                    <label for="spanish">
							<input
								type="radio"
								id="spanish"
								name="foodChoice"
								value="Spanish"
							/>
							<span>Spanish</span>
						</label>
                </div>
                <div class="foodbutton">
                    <label for="mexican">
							<input
								type="radio"
								id="mexican"
								name="foodChoice"
								value="Mexican"
							/>
							<span>Mexican</span>
						</label>
                </div>
                <div class="foodbutton">
                    <label for="australian">
							<input
								type="radio"
								id="australian"
								name="foodChoice"
								value="Australian"
							/>
							<span>Australian</span>
						</label>
                </div>
            </fieldset>
            <button>Submit!</button>
        </form>
    </section>

    <p>Room ID: <span id="roomIdDisplay"></span></p>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // socket.io connection
        const socket = io();

        // on load
        let waitingInterval;

        // document variables
        const form = document.getElementById("form");
        const foodChoices = document.getElementsByName("foodChoice");
        const foodButtons = document.getElementsByClassName("foodbutton");
        const roomIdDisplay = document.getElementById("roomIdDisplay");

        form.addEventListener("submit", function(e) {
            e.preventDefault();
            const removedChoice = document.querySelector(
                'input[name="foodChoice"]:checked'
            ).value;
            if (removedChoice) {
                const room = roomIdDisplay.textContent;
                socket.emit("food choice", removedChoice, room);
            }
        });

        // socket functions
        const handleCreateRoom = () => {
            socket.emit("createRoom");
            socket.on("init", (roomId, clientNo, roomSize) => {
                document.getElementById("roomIdDisplay").textContent = roomId;
                document.getElementById("loader").style.display = "block";
                document.getElementById("roomInput").style.display = "none";
                waitingInterval = setInterval(waitingInRoom, 500);
            });
        };

        const handleJoinRoom = () => {
            const roomId = document.getElementById("roomId").value;
            socket.emit("joinRoom", roomId);
            socket.on("init", (roomId, clientNo, roomSize) => {
                document.getElementById("roomIdDisplay").textContent = roomId;
                document.getElementById("loader").style.display = "block";
                document.getElementById("roomInput").style.display = "none";
                waitingInterval = setInterval(waitingInRoom, 500);
            });
        };

        document
            .getElementById("newRoom")
            .addEventListener("click", handleCreateRoom);
        document
            .getElementById("joinRoom")
            .addEventListener("click", handleJoinRoom);

        const waitingInRoom = () => {
            console.log("waiting!");
            socket.emit(
                "waitingInRoom",
                document.getElementById("roomIdDisplay").textContent
            );
        };

        socket.on("fullRoom", () => {
            clearInterval(waitingInterval);
            document.getElementById("loader").style.display = "none";
            document.getElementById("selection").style.display = "flex";
        });

        const handleErrors = (error) => {
            alert(`${error.status}: ${error.message}`);
        };

        socket.on("throwError", (error) => handleErrors(error));

        socket.on("fullRoom", () => {
            console.log("room full!");
            document.getElementById("loader").style.display = "none";
            document.getElementById("selection").style.display = "flex";
        });

        socket.on("food choice", function(deleteChoice, roomId) {
            if (roomId !== roomIdDisplay.textContent) {
                return;
            }

            for (let i = 0; i < foodChoices.length; i++) {
                if (foodChoices[i].value === deleteChoice) {
                    foodChoices[i].style.display = "none";
                    foodButtons[i].style.display = "none";
                }
            }
            window.scrollTo(0, document.body.scrollHeight);
        });
    </script>
</body>

</html>